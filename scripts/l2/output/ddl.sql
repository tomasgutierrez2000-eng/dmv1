-- L2 Schema DDL (generated from scripts/l2/generate.ts)
-- Run after scripts/l1/output/ddl.sql. PostgreSQL 15+.
SET search_path TO l1, l2, public;

CREATE SCHEMA IF NOT EXISTS l2;

CREATE TABLE IF NOT EXISTS l2.position (
  position_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  facility_id BIGINT,
  instrument_id BIGINT,
  position_type VARCHAR(50),
  balance_amount NUMERIC(18,2),
  currency_code VARCHAR(20),
  source_system_id BIGINT,
  accrued_interest_amt NUMERIC(18,2),
  book_value_amt NUMERIC(18,2),
  contractual_maturity_date DATE,
  counterparty_id BIGINT,
  credit_agreement_id BIGINT,
  credit_status_code VARCHAR(20),
  effective_date DATE,
  exposure_type_code VARCHAR(20),
  external_risk_rating VARCHAR(100),
  internal_risk_rating VARCHAR(100),
  legal_entity_id BIGINT,
  lgd_estimate VARCHAR(100),
  market_value_amt NUMERIC(18,2),
  netting_set_id BIGINT,
  notional_amount NUMERIC(18,2),
  pd_estimate VARCHAR(100),
  position_currency VARCHAR(100),
  trading_banking_book_flag CHAR(1),
  ultimate_parent_id BIGINT,
  CONSTRAINT fk_position_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_position_instrument_id FOREIGN KEY (instrument_id) REFERENCES l1.instrument_master(instrument_id),
  CONSTRAINT fk_position_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code),
  CONSTRAINT fk_position_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.position_detail (
  position_detail_id BIGINT NOT NULL PRIMARY KEY,
  position_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  detail_type VARCHAR(50),
  amount NUMERIC(18,2),
  maturity_date DATE,
  cash_leg_amount NUMERIC(18,2),
  ccf VARCHAR(100),
  current_balance NUMERIC(18,2),
  days_past_due INTEGER,
  delinquency_status VARCHAR(30),
  derivative_type VARCHAR(50),
  fair_value NUMERIC(18,2),
  funded_amount NUMERIC(18,2),
  haircut_applied_pct NUMERIC(10,4),
  insured_balance NUMERIC(18,2),
  interest_rate NUMERIC(8,6),
  mark_to_market NUMERIC(18,2),
  origination_date DATE,
  pfe VARCHAR(100),
  quantity INTEGER,
  rate_index NUMERIC(10,4),
  rate_type CHAR(1),
  replacement_cost NUMERIC(18,2),
  sft_type VARCHAR(50),
  spread_bps NUMERIC(8,2),
  total_commitment NUMERIC(18,2),
  unfunded_amount NUMERIC(18,2),
  unrealized_gain_loss VARCHAR(100),
  product_node_id BIGINT,
  exposure_type_code VARCHAR(20),
  notional_amount NUMERIC(18,2),
  credit_conversion_factor NUMERIC(10,6),
  lgd_pct NUMERIC(10,6),
  risk_weight_pct NUMERIC(10,6),
  delinquent_payment_flag CHAR(1),
  overdue_amt_0_30 NUMERIC(18,2),
  overdue_amt_31_60 NUMERIC(18,2),
  overdue_amt_61_90_plus NUMERIC(18,2),
  CONSTRAINT fk_position_detail_position_id FOREIGN KEY (position_id) REFERENCES l2.position(position_id)
);

CREATE TABLE IF NOT EXISTS l2.exposure_counterparty_attribution (
  attribution_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  exposure_type_id BIGINT NOT NULL,
  counterparty_id BIGINT NOT NULL,
  exposure_amount NUMERIC(18,2),
  currency_code VARCHAR(20),
  attributed_exposure_usd NUMERIC(18,2),
  attribution_pct NUMERIC(10,4),
  counterparty_role_code VARCHAR(20),
  facility_id BIGINT,
  is_risk_shifted_flag CHAR(1),
  risk_shifted_from_counterparty_id BIGINT,
  PRIMARY KEY (attribution_id, as_of_date),
  CONSTRAINT fk_exposure_counterparty_attribution_exposure_type_id FOREIGN KEY (exposure_type_id) REFERENCES l1.exposure_type_dim(exposure_type_id),
  CONSTRAINT fk_exposure_counterparty_attribution_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id),
  CONSTRAINT fk_exposure_counterparty_attribution_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code)
);

CREATE TABLE IF NOT EXISTS l2.facility_exposure_snapshot (
  facility_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  exposure_type_id BIGINT NOT NULL,
  drawn_amount NUMERIC(18,2),
  committed_amount NUMERIC(18,2),
  undrawn_amount NUMERIC(18,2),
  source_system_id BIGINT,
  counterparty_id BIGINT,
  coverage_ratio_pct NUMERIC(10,4),
  currency_code VARCHAR(20),
  exposure_amount_local NUMERIC(18,2),
  facility_exposure_id BIGINT,
  fr2590_category_code VARCHAR(20),
  gross_exposure_usd NUMERIC(18,2),
  legal_entity_id BIGINT,
  lob_segment_id BIGINT,
  net_exposure_usd NUMERIC(18,2),
  product_node_id BIGINT,
  outstanding_balance_amt NUMERIC(18,2),
  undrawn_commitment_amt NUMERIC(18,2),
  number_of_loans INTEGER,
  number_of_facilities INTEGER,
  days_until_maturity INTEGER,
  facility_utilization_status VARCHAR(30),
  limit_status_code VARCHAR(30),
  rwa_amt NUMERIC(18,2),
  internal_risk_rating_bucket_code VARCHAR(20),
  PRIMARY KEY (facility_id, as_of_date),
  CONSTRAINT fk_facility_exposure_snapshot_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_facility_exposure_snapshot_exposure_type_id FOREIGN KEY (exposure_type_id) REFERENCES l1.exposure_type_dim(exposure_type_id),
  CONSTRAINT fk_facility_exposure_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id),
  CONSTRAINT fk_facility_exposure_snapshot_internal_risk_rating_bucket_code FOREIGN KEY (internal_risk_rating_bucket_code) REFERENCES l1.internal_risk_rating_bucket_dim(internal_risk_rating_bucket_code)
);

CREATE TABLE IF NOT EXISTS l2.netting_set_exposure_snapshot (
  netting_set_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  netted_exposure_amount NUMERIC(18,2),
  gross_exposure_amount NUMERIC(18,2),
  currency_code VARCHAR(20),
  collateral_held_usd NUMERIC(18,2),
  counterparty_id BIGINT,
  gross_mtm_usd NUMERIC(18,2),
  legal_entity_id BIGINT,
  netting_set_exposure_id BIGINT,
  pfe_usd NUMERIC(18,2),
  netting_benefit_amt NUMERIC(18,2),
  PRIMARY KEY (netting_set_id, as_of_date),
  CONSTRAINT fk_netting_set_exposure_snapshot_netting_set_id FOREIGN KEY (netting_set_id) REFERENCES l1.netting_set(netting_set_id),
  CONSTRAINT fk_netting_set_exposure_snapshot_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code)
);

CREATE TABLE IF NOT EXISTS l2.facility_lob_attribution (
  attribution_id BIGINT NOT NULL PRIMARY KEY,
  facility_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  lob_segment_id BIGINT NOT NULL,
  attribution_pct NUMERIC(10,4),
  attributed_amount NUMERIC(18,2),
  attribution_amount_usd NUMERIC(18,2),
  attribution_type VARCHAR(50),
  lob_node_id BIGINT,
  hierarchy_id VARCHAR(64),
  CONSTRAINT fk_facility_lob_attribution_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_facility_lob_attribution_lob_segment_id FOREIGN KEY (lob_segment_id) REFERENCES l1.enterprise_business_taxonomy(managed_segment_id)
);

CREATE TABLE IF NOT EXISTS l2.collateral_snapshot (
  collateral_asset_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  valuation_amount NUMERIC(18,2),
  haircut_pct NUMERIC(10,4),
  eligible_collateral_amount NUMERIC(18,2),
  source_system_id BIGINT,
  allocated_amount_usd NUMERIC(18,2),
  collateral_snapshot_id BIGINT,
  counterparty_id BIGINT,
  crm_type_code VARCHAR(20),
  current_valuation_usd NUMERIC(18,2),
  facility_id BIGINT,
  mitigant_group_code VARCHAR(20),
  mitigant_subtype VARCHAR(100),
  original_valuation_usd NUMERIC(18,2),
  risk_shifting_flag CHAR(1),
  PRIMARY KEY (collateral_asset_id, as_of_date),
  CONSTRAINT fk_collateral_snapshot_collateral_asset_id FOREIGN KEY (collateral_asset_id) REFERENCES l1.collateral_asset_master(collateral_asset_id),
  CONSTRAINT fk_collateral_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.cash_flow (
  cash_flow_id BIGINT NOT NULL PRIMARY KEY,
  facility_id BIGINT,
  cash_flow_date DATE NOT NULL,
  cash_flow_type VARCHAR(50),
  amount NUMERIC(18,2),
  currency_code VARCHAR(20),
  as_of_date DATE,
  contractual_amt NUMERIC(18,2),
  contractual_amt_usd NUMERIC(18,2),
  counterparty_id BIGINT,
  flow_date DATE,
  flow_direction VARCHAR(100),
  flow_id BIGINT,
  flow_type VARCHAR(50),
  maturity_bucket_id BIGINT,
  position_id BIGINT,
  CONSTRAINT fk_cash_flow_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_cash_flow_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code)
);

CREATE TABLE IF NOT EXISTS l2.facility_financial_snapshot (
  facility_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  noi_amt NUMERIC(18,2),
  total_debt_service_amt NUMERIC(18,2),
  revenue_amt NUMERIC(18,2),
  operating_expense_amt NUMERIC(18,2),
  ebitda_amt NUMERIC(18,2),
  interest_expense_amt NUMERIC(18,2),
  principal_payment_amt NUMERIC(18,2),
  counterparty_id BIGINT,
  currency_code VARCHAR(20),
  reporting_period VARCHAR(20),
  financial_snapshot_id BIGINT,
  dscr_value NUMERIC(12,6),
  ltv_pct NUMERIC(10,6),
  net_income_amt NUMERIC(18,2),
  interest_rate_sensitivity_pct NUMERIC(10,6),
  PRIMARY KEY (facility_id, as_of_date),
  CONSTRAINT fk_facility_financial_snapshot_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id)
);

CREATE TABLE IF NOT EXISTS l2.facility_delinquency_snapshot (
  facility_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  credit_status_code BIGINT NOT NULL,
  days_past_due INTEGER,
  watch_list_flag CHAR(1),
  counterparty_id BIGINT,
  currency_code VARCHAR(20),
  days_past_due_max INTEGER,
  delinquency_bucket_code VARCHAR(20),
  delinquency_snapshot_id BIGINT,
  delinquency_status_code VARCHAR(20),
  last_payment_received_date DATE,
  overdue_interest_amt NUMERIC(18,2),
  overdue_principal_amt NUMERIC(18,2),
  delinquent_payment_flag CHAR(1),
  overdue_amt_0_30 NUMERIC(18,2),
  overdue_amt_31_60 NUMERIC(18,2),
  overdue_amt_61_90_plus NUMERIC(18,2),
  PRIMARY KEY (facility_id, as_of_date),
  CONSTRAINT fk_facility_delinquency_snapshot_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_facility_delinquency_snapshot_credit_status_code FOREIGN KEY (credit_status_code) REFERENCES l1.credit_status_dim(credit_status_code)
);

CREATE TABLE IF NOT EXISTS l2.facility_pricing_snapshot (
  facility_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  spread_bps NUMERIC(10,2),
  rate_index_id BIGINT,
  all_in_rate_pct NUMERIC(10,4),
  floor_pct NUMERIC(10,4),
  base_rate_pct NUMERIC(10,4),
  currency_code VARCHAR(20),
  facility_pricing_id BIGINT,
  min_spread_threshold_bps NUMERIC(8,2),
  payment_frequency VARCHAR(30),
  prepayment_penalty_flag CHAR(1),
  rate_cap_pct NUMERIC(10,4),
  rate_index_code NUMERIC(10,4),
  pricing_tier VARCHAR(20),
  pricing_exception_flag CHAR(1),
  fee_rate_pct NUMERIC(10,6),
  PRIMARY KEY (facility_id, as_of_date),
  CONSTRAINT fk_facility_pricing_snapshot_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_facility_pricing_snapshot_rate_index_id FOREIGN KEY (rate_index_id) REFERENCES l1.interest_rate_index_dim(rate_index_id),
  CONSTRAINT fk_facility_pricing_snapshot_pricing_tier FOREIGN KEY (pricing_tier) REFERENCES l1.pricing_tier_dim(pricing_tier_code)
);

CREATE TABLE IF NOT EXISTS l2.facility_profitability_snapshot (
  facility_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  nii_ytd NUMERIC(18,2),
  fee_income_ytd NUMERIC(18,2),
  ledger_account_id BIGINT,
  allocated_equity_amt NUMERIC(18,2),
  avg_earning_assets_amt NUMERIC(18,2),
  base_currency_code VARCHAR(20),
  fee_income_amt NUMERIC(18,2),
  interest_expense_amt NUMERIC(18,2),
  interest_income_amt NUMERIC(18,2),
  profitability_snapshot_id BIGINT,
  PRIMARY KEY (facility_id, as_of_date),
  CONSTRAINT fk_facility_profitability_snapshot_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_facility_profitability_snapshot_ledger_account_id FOREIGN KEY (ledger_account_id) REFERENCES l1.ledger_account_dim(ledger_account_id)
);

CREATE TABLE IF NOT EXISTS l2.limit_contribution_snapshot (
  limit_rule_id BIGINT NOT NULL,
  counterparty_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  contribution_amount NUMERIC(18,2),
  currency_code VARCHAR(20),
  contribution_amount_usd NUMERIC(18,2),
  contribution_id BIGINT,
  contribution_pct NUMERIC(10,4),
  facility_id BIGINT,
  PRIMARY KEY (limit_rule_id, counterparty_id, as_of_date),
  CONSTRAINT fk_limit_contribution_snapshot_limit_rule_id FOREIGN KEY (limit_rule_id) REFERENCES l1.limit_rule(limit_rule_id),
  CONSTRAINT fk_limit_contribution_snapshot_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id),
  CONSTRAINT fk_limit_contribution_snapshot_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code)
);

CREATE TABLE IF NOT EXISTS l2.limit_utilization_event (
  limit_rule_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  counterparty_id BIGINT,
  utilized_amount NUMERIC(18,2),
  available_amount NUMERIC(18,2),
  reporting_ts TIMESTAMP,
  utilization_event_id BIGINT,
  utilized_amount_usd NUMERIC(18,2),
  PRIMARY KEY (limit_rule_id, as_of_date),
  CONSTRAINT fk_limit_utilization_event_limit_rule_id FOREIGN KEY (limit_rule_id) REFERENCES l1.limit_rule(limit_rule_id),
  CONSTRAINT fk_limit_utilization_event_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id)
);

CREATE TABLE IF NOT EXISTS l2.amendment_change_detail (
  change_detail_id BIGINT NOT NULL PRIMARY KEY,
  amendment_id BIGINT NOT NULL,
  change_type VARCHAR(50),
  old_value TEXT,
  new_value TEXT,
  amendment_event_id BIGINT,
  change_currency_code VARCHAR(20),
  change_field_name VARCHAR(200),
  change_seq BIGINT,
  CONSTRAINT fk_amendment_change_detail_amendment_id FOREIGN KEY (amendment_id) REFERENCES l2.amendment_event(amendment_id)
);

CREATE TABLE IF NOT EXISTS l2.amendment_event (
  amendment_id BIGINT NOT NULL PRIMARY KEY,
  facility_id BIGINT NOT NULL,
  credit_agreement_id BIGINT NOT NULL,
  amendment_type_code VARCHAR(20) NOT NULL,
  amendment_status_code VARCHAR(20) NOT NULL,
  effective_date DATE,
  event_ts TIMESTAMP,
  amendment_description VARCHAR(2000),
  amendment_event_id BIGINT,
  amendment_status VARCHAR(30),
  amendment_subtype VARCHAR(100),
  amendment_type VARCHAR(50),
  as_of_date DATE,
  completed_date DATE,
  counterparty_id BIGINT,
  identified_date DATE,
  last_updated_ts TIMESTAMP,
  CONSTRAINT fk_amendment_event_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_amendment_event_credit_agreement_id FOREIGN KEY (credit_agreement_id) REFERENCES l1.credit_agreement_master(credit_agreement_id),
  CONSTRAINT fk_amendment_event_amendment_type_code FOREIGN KEY (amendment_type_code) REFERENCES l1.amendment_type_dim(amendment_type_code),
  CONSTRAINT fk_amendment_event_amendment_status_code FOREIGN KEY (amendment_status_code) REFERENCES l1.amendment_status_dim(amendment_status_code)
);

CREATE TABLE IF NOT EXISTS l2.credit_event (
  credit_event_id BIGINT NOT NULL PRIMARY KEY,
  counterparty_id BIGINT NOT NULL,
  credit_event_type_code BIGINT NOT NULL,
  event_date DATE NOT NULL,
  event_ts TIMESTAMP,
  default_definition_id BIGINT,
  as_of_date DATE,
  event_risk_rating VARCHAR(100),
  event_status VARCHAR(30),
  event_summary VARCHAR(2000),
  loss_amount_usd NUMERIC(18,2),
  recovery_amount_usd NUMERIC(18,2),
  CONSTRAINT fk_credit_event_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id),
  CONSTRAINT fk_credit_event_credit_event_type_code FOREIGN KEY (credit_event_type_code) REFERENCES l1.credit_event_type_dim(credit_event_type_code),
  CONSTRAINT fk_credit_event_default_definition_id FOREIGN KEY (default_definition_id) REFERENCES l1.default_definition_dim(default_definition_id)
);

CREATE TABLE IF NOT EXISTS l2.credit_event_facility_link (
  link_id BIGINT NOT NULL PRIMARY KEY,
  credit_event_id BIGINT NOT NULL,
  facility_id BIGINT NOT NULL,
  exposure_at_default NUMERIC(18,2),
  as_of_date DATE,
  estimated_loss_usd NUMERIC(18,2),
  impact_pct NUMERIC(10,4),
  CONSTRAINT fk_credit_event_facility_link_credit_event_id FOREIGN KEY (credit_event_id) REFERENCES l2.credit_event(credit_event_id),
  CONSTRAINT fk_credit_event_facility_link_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id)
);

CREATE TABLE IF NOT EXISTS l2.stress_test_breach (
  breach_id BIGINT NOT NULL PRIMARY KEY,
  scenario_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  limit_rule_id BIGINT,
  counterparty_id BIGINT,
  breach_amount NUMERIC(18,2),
  breach_amount_usd NUMERIC(18,2),
  breach_severity VARCHAR(100),
  control_description VARCHAR(2000),
  control_owner VARCHAR(100),
  failure_description VARCHAR(2000),
  lob_segment_id BIGINT,
  stress_test_result_id BIGINT,
  CONSTRAINT fk_stress_test_breach_scenario_id FOREIGN KEY (scenario_id) REFERENCES l1.scenario_dim(scenario_id),
  CONSTRAINT fk_stress_test_breach_limit_rule_id FOREIGN KEY (limit_rule_id) REFERENCES l1.limit_rule(limit_rule_id),
  CONSTRAINT fk_stress_test_breach_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id)
);

CREATE TABLE IF NOT EXISTS l2.stress_test_result (
  result_id BIGINT NOT NULL PRIMARY KEY,
  scenario_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  portfolio_id BIGINT,
  loss_amount NUMERIC(18,2),
  pnl_impact NUMERIC(18,2),
  capital_impact_pct NUMERIC(10,4),
  execution_date DATE,
  expected_loss_usd NUMERIC(18,2),
  result_description VARCHAR(2000),
  result_status VARCHAR(30),
  scenario_type VARCHAR(50),
  stress_test_result_id BIGINT,
  total_breaches INTEGER,
  total_exposure_usd NUMERIC(18,2),
  CONSTRAINT fk_stress_test_result_scenario_id FOREIGN KEY (scenario_id) REFERENCES l1.scenario_dim(scenario_id),
  CONSTRAINT fk_stress_test_result_portfolio_id FOREIGN KEY (portfolio_id) REFERENCES l1.portfolio_dim(portfolio_id)
);

CREATE TABLE IF NOT EXISTS l2.deal_pipeline_fact (
  pipeline_id BIGINT NOT NULL PRIMARY KEY,
  counterparty_id BIGINT,
  as_of_date DATE NOT NULL,
  stage_code VARCHAR(50),
  proposed_amount NUMERIC(18,2),
  currency_code VARCHAR(20),
  expected_all_in_rate_pct NUMERIC(10,4),
  expected_close_date DATE,
  expected_committed_amt NUMERIC(18,2),
  expected_coverage_ratio NUMERIC(10,4),
  expected_exposure_amt NUMERIC(18,2),
  expected_internal_risk_grade VARCHAR(255),
  expected_spread_bps NUMERIC(8,2),
  expected_tenor_months VARCHAR(255),
  facility_id BIGINT,
  lob_segment_id BIGINT,
  pipeline_deal_id BIGINT,
  pipeline_stage VARCHAR(100),
  pipeline_status VARCHAR(30),
  record_level_code VARCHAR(20),
  CONSTRAINT fk_deal_pipeline_fact_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id),
  CONSTRAINT fk_deal_pipeline_fact_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code)
);

CREATE TABLE IF NOT EXISTS l2.counterparty_rating_observation (
  observation_id BIGINT NOT NULL PRIMARY KEY,
  counterparty_id BIGINT NOT NULL,
  as_of_date DATE NOT NULL,
  rating_grade_id BIGINT NOT NULL,
  rating_source_id BIGINT NOT NULL,
  is_internal_flag CHAR(1),
  pd_implied VARCHAR(100),
  prior_rating_value NUMERIC(18,4),
  rating_agency VARCHAR(100),
  rating_date DATE,
  rating_type VARCHAR(50),
  rating_value NUMERIC(18,4),
  risk_rating_status VARCHAR(30),
  risk_rating_change_steps INTEGER,
  CONSTRAINT fk_counterparty_rating_observation_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id),
  CONSTRAINT fk_counterparty_rating_observation_rating_grade_id FOREIGN KEY (rating_grade_id) REFERENCES l1.rating_grade_dim(rating_grade_id),
  CONSTRAINT fk_counterparty_rating_observation_rating_source_id FOREIGN KEY (rating_source_id) REFERENCES l1.rating_source(rating_source_id)
);

CREATE TABLE IF NOT EXISTS l2.financial_metric_observation (
  observation_id BIGINT NOT NULL PRIMARY KEY,
  counterparty_id BIGINT,
  facility_id BIGINT,
  as_of_date DATE NOT NULL,
  metric_definition_id BIGINT NOT NULL,
  value NUMERIC(18,4),
  context_id BIGINT,
  credit_agreement_id BIGINT,
  metric_category VARCHAR(50),
  metric_code VARCHAR(20),
  metric_name VARCHAR(200),
  metric_value NUMERIC(18,4),
  metric_value_usd NUMERIC(18,2),
  period_end_date DATE,
  CONSTRAINT fk_financial_metric_observation_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id),
  CONSTRAINT fk_financial_metric_observation_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_financial_metric_observation_metric_definition_id FOREIGN KEY (metric_definition_id) REFERENCES l1.metric_definition_dim(metric_definition_id),
  CONSTRAINT fk_financial_metric_observation_context_id FOREIGN KEY (context_id) REFERENCES l1.context_dim(context_id)
);

CREATE TABLE IF NOT EXISTS l2.metric_threshold (
  threshold_id BIGINT NOT NULL PRIMARY KEY,
  metric_definition_id BIGINT NOT NULL,
  threshold_type VARCHAR(50),
  threshold_value NUMERIC(18,4),
  effective_from_date DATE,
  effective_to_date DATE,
  active_flag CHAR(1),
  inner_threshold_pct NUMERIC(10,4),
  last_threshold_updated_date DATE,
  limit_type VARCHAR(50),
  limit_value NUMERIC(18,4),
  lod1_sponsor VARCHAR(100),
  lod2_sponsor VARCHAR(100),
  metric_category VARCHAR(50),
  metric_code VARCHAR(20),
  metric_description VARCHAR(2000),
  metric_id_display VARCHAR(100),
  metric_name VARCHAR(200),
  metric_owner VARCHAR(100),
  metric_threshold_id BIGINT,
  outer_threshold_pct NUMERIC(10,4),
  report_deadline VARCHAR(100),
  report_frequency VARCHAR(30),
  CONSTRAINT fk_metric_threshold_metric_definition_id FOREIGN KEY (metric_definition_id) REFERENCES l1.metric_definition_dim(metric_definition_id)
);

CREATE TABLE IF NOT EXISTS l2.exception_event (
  exception_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  exception_type VARCHAR(50),
  facility_id BIGINT,
  counterparty_id BIGINT,
  raised_ts TIMESTAMP,
  resolved_ts TIMESTAMP,
  actual_remediation_date DATE,
  approver VARCHAR(100),
  breach_amount_usd NUMERIC(18,2),
  breach_pct NUMERIC(10,4),
  days_open INTEGER,
  exception_description VARCHAR(2000),
  exception_owner VARCHAR(100),
  exception_severity VARCHAR(100),
  exception_status VARCHAR(30),
  exception_value NUMERIC(18,4),
  identified_date DATE,
  limit_rule_id BIGINT,
  lob_segment_id BIGINT,
  lod_sponsor VARCHAR(100),
  metric_threshold_id BIGINT,
  remediation_plan VARCHAR(2000),
  target_remediation_date DATE,
  threshold_value NUMERIC(18,4),
  CONSTRAINT fk_exception_event_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_exception_event_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id)
);

CREATE TABLE IF NOT EXISTS l2.risk_flag (
  risk_flag_id BIGINT NOT NULL PRIMARY KEY,
  facility_id BIGINT,
  counterparty_id BIGINT,
  flag_type VARCHAR(50) NOT NULL,
  as_of_date DATE NOT NULL,
  raised_ts TIMESTAMP,
  cleared_ts TIMESTAMP,
  created_ts TIMESTAMP,
  flag_code VARCHAR(20),
  flag_description VARCHAR(2000),
  flag_scope VARCHAR(30),
  flag_severity VARCHAR(100),
  flag_trigger_value NUMERIC(18,4),
  CONSTRAINT fk_risk_flag_facility_id FOREIGN KEY (facility_id) REFERENCES l1.facility_master(facility_id),
  CONSTRAINT fk_risk_flag_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id)
);

CREATE TABLE IF NOT EXISTS l2.data_quality_score_snapshot (
  score_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  target_table VARCHAR(100),
  source_system_id BIGINT,
  completeness_pct NUMERIC(10,4),
  validity_pct NUMERIC(10,4),
  overall_score NUMERIC(10,4),
  dimension_id BIGINT,
  dimension_name VARCHAR(200),
  dq_score_id BIGINT,
  dq_score_pct NUMERIC(10,4),
  impact_pct NUMERIC(10,4),
  impacted_report_codes VARCHAR(20),
  issue_count INTEGER,
  reconciliation_break_count INTEGER,
  score_dimension VARCHAR(30),
  CONSTRAINT fk_data_quality_score_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.securities_position_snapshot (
  securities_position_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  par_amount NUMERIC(18,2),
  market_value_amt NUMERIC(18,2),
  book_value_amt NUMERIC(18,2),
  unrealized_gain_loss_amt NUMERIC(18,2),
  accrued_interest_amt NUMERIC(18,2),
  hqla_eligible_value_amt NUMERIC(18,2),
  is_encumbered_flag CHAR(1),
  encumbered_value_amt NUMERIC(18,2),
  unencumbered_value_amt NUMERIC(18,2),
  remaining_maturity_days INTEGER,
  duration_years NUMERIC(10,4),
  credit_spread_bps NUMERIC(10,2),
  source_system_id BIGINT,
  CONSTRAINT fk_securities_position_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.deposit_balance_snapshot (
  deposit_product_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  legal_entity_id BIGINT NOT NULL,
  currency_code VARCHAR(20),
  total_balance_amt NUMERIC(18,2),
  insured_balance_amt NUMERIC(18,2),
  uninsured_balance_amt NUMERIC(18,2),
  account_count INTEGER,
  weighted_avg_maturity_days INTEGER,
  weighted_avg_rate_pct NUMERIC(10,4),
  lcr_outflow_amt NUMERIC(18,2),
  nsfr_asf_amt NUMERIC(18,2),
  concentration_top10_pct NUMERIC(10,4),
  behavioral_maturity_days INTEGER,
  surge_balance_amt NUMERIC(18,2),
  core_deposit_amt NUMERIC(18,2),
  source_system_id BIGINT,
  CONSTRAINT fk_deposit_balance_snapshot_deposit_product_id FOREIGN KEY (deposit_product_id) REFERENCES l1.deposit_product_master(deposit_product_id),
  CONSTRAINT fk_deposit_balance_snapshot_legal_entity_id FOREIGN KEY (legal_entity_id) REFERENCES l1.legal_entity(legal_entity_id),
  CONSTRAINT fk_deposit_balance_snapshot_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code),
  CONSTRAINT fk_deposit_balance_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.wholesale_funding_snapshot (
  wholesale_funding_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  outstanding_amount NUMERIC(18,2),
  market_value_collateral_amt NUMERIC(18,2),
  remaining_maturity_days INTEGER,
  rollover_assumption_pct NUMERIC(10,4),
  lcr_outflow_amt NUMERIC(18,2),
  nsfr_asf_amt NUMERIC(18,2),
  cost_rate_pct NUMERIC(10,4),
  spread_to_benchmark_bps NUMERIC(10,2),
  currency_code VARCHAR(20),
  source_system_id BIGINT,
  CONSTRAINT fk_wholesale_funding_snapshot_wholesale_funding_id FOREIGN KEY (wholesale_funding_id) REFERENCES l1.wholesale_funding_instrument_master(wholesale_funding_id),
  CONSTRAINT fk_wholesale_funding_snapshot_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code),
  CONSTRAINT fk_wholesale_funding_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.liquidity_cash_flow_projection (
  cash_flow_projection_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  legal_entity_id BIGINT NOT NULL,
  liquidity_bucket_id BIGINT NOT NULL,
  cash_flow_category VARCHAR(30) NOT NULL,
  flow_type VARCHAR(50) NOT NULL,
  flow_direction VARCHAR(10) NOT NULL,
  currency_code VARCHAR(20),
  gross_amount NUMERIC(18,2),
  haircut_or_runoff_pct NUMERIC(10,4),
  net_amount NUMERIC(18,2),
  scenario_id BIGINT,
  source_instrument_type VARCHAR(50),
  source_record_id BIGINT,
  model_id BIGINT,
  source_system_id BIGINT,
  CONSTRAINT fk_liquidity_cash_flow_projection_legal_entity_id FOREIGN KEY (legal_entity_id) REFERENCES l1.legal_entity(legal_entity_id),
  CONSTRAINT fk_liquidity_cash_flow_projection_liquidity_bucket_id FOREIGN KEY (liquidity_bucket_id) REFERENCES l1.liquidity_time_bucket_dim(liquidity_bucket_id),
  CONSTRAINT fk_liquidity_cash_flow_projection_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code),
  CONSTRAINT fk_liquidity_cash_flow_projection_scenario_id FOREIGN KEY (scenario_id) REFERENCES l1.scenario_dim(scenario_id),
  CONSTRAINT fk_liquidity_cash_flow_projection_model_id FOREIGN KEY (model_id) REFERENCES l1.model_registry_dim(model_id),
  CONSTRAINT fk_liquidity_cash_flow_projection_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.derivative_margin_snapshot (
  netting_set_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  csa_id BIGINT,
  counterparty_id BIGINT NOT NULL,
  legal_entity_id BIGINT NOT NULL,
  currency_code VARCHAR(20),
  gross_mtm_amt NUMERIC(18,2),
  net_mtm_amt NUMERIC(18,2),
  vm_posted_amt NUMERIC(18,2),
  vm_received_amt NUMERIC(18,2),
  im_posted_amt NUMERIC(18,2),
  im_received_amt NUMERIC(18,2),
  potential_vm_call_amt NUMERIC(18,2),
  potential_im_call_amt NUMERIC(18,2),
  lcr_outflow_from_margin_amt NUMERIC(18,2),
  downgrade_trigger_notional_amt NUMERIC(18,2),
  source_system_id BIGINT,
  CONSTRAINT fk_derivative_margin_snapshot_netting_set_id FOREIGN KEY (netting_set_id) REFERENCES l1.netting_set(netting_set_id),
  CONSTRAINT fk_derivative_margin_snapshot_csa_id FOREIGN KEY (csa_id) REFERENCES l1.csa_master(csa_id),
  CONSTRAINT fk_derivative_margin_snapshot_counterparty_id FOREIGN KEY (counterparty_id) REFERENCES l1.counterparty(counterparty_id),
  CONSTRAINT fk_derivative_margin_snapshot_legal_entity_id FOREIGN KEY (legal_entity_id) REFERENCES l1.legal_entity(legal_entity_id),
  CONSTRAINT fk_derivative_margin_snapshot_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code),
  CONSTRAINT fk_derivative_margin_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.capital_instrument_snapshot (
  capital_instrument_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  carrying_value_amt NUMERIC(18,2),
  regulatory_value_amt NUMERIC(18,2),
  accrued_interest_amt NUMERIC(18,2),
  fair_value_amt NUMERIC(18,2),
  amortization_remaining_amt NUMERIC(18,2),
  transitional_adjustment_amt NUMERIC(18,2),
  currency_code VARCHAR(20),
  fx_rate_to_reporting NUMERIC(18,10),
  reporting_currency_value_amt NUMERIC(18,2),
  source_system_id BIGINT,
  CONSTRAINT fk_capital_instrument_snapshot_capital_instrument_id FOREIGN KEY (capital_instrument_id) REFERENCES l1.capital_instrument_master(capital_instrument_id),
  CONSTRAINT fk_capital_instrument_snapshot_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code),
  CONSTRAINT fk_capital_instrument_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.capital_deduction_snapshot (
  deduction_snapshot_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  legal_entity_id BIGINT NOT NULL,
  deduction_type_id BIGINT NOT NULL,
  gross_deduction_amt NUMERIC(18,2),
  threshold_allowance_amt NUMERIC(18,2),
  net_deduction_amt NUMERIC(18,2),
  deducted_from_tier VARCHAR(10),
  transitional_adjustment_amt NUMERIC(18,2),
  currency_code VARCHAR(20),
  source_system_id BIGINT,
  CONSTRAINT fk_capital_deduction_snapshot_legal_entity_id FOREIGN KEY (legal_entity_id) REFERENCES l1.legal_entity(legal_entity_id),
  CONSTRAINT fk_capital_deduction_snapshot_deduction_type_id FOREIGN KEY (deduction_type_id) REFERENCES l1.capital_deduction_type_dim(deduction_type_id),
  CONSTRAINT fk_capital_deduction_snapshot_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code),
  CONSTRAINT fk_capital_deduction_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.rwa_snapshot (
  rwa_snapshot_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  legal_entity_id BIGINT NOT NULL,
  rwa_risk_type_id BIGINT NOT NULL,
  portfolio_id BIGINT,
  exposure_amount NUMERIC(18,2),
  risk_weight_pct NUMERIC(10,6),
  rwa_amount NUMERIC(18,2),
  capital_requirement_amt NUMERIC(18,2),
  prior_period_rwa_amount NUMERIC(18,2),
  rwa_density_pct NUMERIC(10,6),
  model_id BIGINT,
  currency_code VARCHAR(20),
  source_system_id BIGINT,
  CONSTRAINT fk_rwa_snapshot_legal_entity_id FOREIGN KEY (legal_entity_id) REFERENCES l1.legal_entity(legal_entity_id),
  CONSTRAINT fk_rwa_snapshot_rwa_risk_type_id FOREIGN KEY (rwa_risk_type_id) REFERENCES l1.rwa_risk_type_dim(rwa_risk_type_id),
  CONSTRAINT fk_rwa_snapshot_portfolio_id FOREIGN KEY (portfolio_id) REFERENCES l1.portfolio_dim(portfolio_id),
  CONSTRAINT fk_rwa_snapshot_model_id FOREIGN KEY (model_id) REFERENCES l1.model_registry_dim(model_id),
  CONSTRAINT fk_rwa_snapshot_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code),
  CONSTRAINT fk_rwa_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);

CREATE TABLE IF NOT EXISTS l2.leverage_exposure_snapshot (
  leverage_snapshot_id BIGINT NOT NULL PRIMARY KEY,
  as_of_date DATE NOT NULL,
  legal_entity_id BIGINT NOT NULL,
  exposure_category VARCHAR(50) NOT NULL,
  exposure_subcategory VARCHAR(50),
  gross_exposure_amt NUMERIC(18,2),
  adjustment_amt NUMERIC(18,2),
  net_exposure_amt NUMERIC(18,2),
  currency_code VARCHAR(20),
  source_system_id BIGINT,
  CONSTRAINT fk_leverage_exposure_snapshot_legal_entity_id FOREIGN KEY (legal_entity_id) REFERENCES l1.legal_entity(legal_entity_id),
  CONSTRAINT fk_leverage_exposure_snapshot_currency_code FOREIGN KEY (currency_code) REFERENCES l1.currency_dim(currency_code),
  CONSTRAINT fk_leverage_exposure_snapshot_source_system_id FOREIGN KEY (source_system_id) REFERENCES l1.source_system_registry(source_system_id)
);
